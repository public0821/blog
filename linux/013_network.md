#网络漫谈

介绍网络是怎么分层的，然后每层负责些什么的书很多，但很少看到有书介绍为什么要这么多分层。

本篇将试着从分层是怎么来的这个角度分析一下网络是如何一步一步发展到今天这样的，希望对网络初学者有所帮助。

>注意：内容是根据自己已有的网络知识构思出来的，可能跟实际情况有出入，仅供参考。

本文采用TCP/IP详解里的5层结构，即物理层、链路层、网络层、传输层和应用层，并且只讨论以太网和常见的组网方式，不考虑特殊场合的应用。

##物理层

物理层就是如何将多台设备连起来，不管是有线还是无线的方式，都是让设备之间能交换数据，所以物理上的连通是必不可少的，不然就没法通信了。

如果只有一台设备，就不需要和别人通信； 两台呢？直接弄根线连上就可以通信了。

三台呢，怎么连？ 可以像下面这样，三根网线搞定
```
               +-------+
    +--------->| Node2 |<---------+
    |          +-------+          |
    |                             |
    ↓                             ↓
+-------+                     +-------+
| Node1 |<------------------->| Node3 |
+-------+                     +-------+

```

四台呢，这么连？
```
                +-------+
    +---------->| Node2 |<----------+
    |           +-------+           |
    |                               |
    ↓                               ↓
+-------+                       +-------+
| Node1 |                       | Node3 |
+-------+                       +-------+
    ↑                               ↑
    |                               |
    |           +-------+           |
    +---------->| Node4 |<----------+
                +-------+
```

虽然四根网线搞定，但带来至少两个问题： 
1. Node2和Node4之间怎么通信？ 
首先肯定得经过Node1或者Node3，就算能根据网络繁忙程度进行智能的选择，Node1和Node3也需要把部分精力用在帮忙转发数据包上，就算转发消耗的系统资源可以忽略不计，但Node1和Node3之间的通信呢？由于带宽有限，Node1和Node3之间的通信肯定会受Node1或者Node3之间通信的影响。

想象一下，寝室里面有四个人，A和C之间传一个电影，导致B和D之间打局域网游戏卡的要死，你说B和D恼火不？

2. Node2和Node4关机之后，Node1或者Node3之间就没法通信了，也就是说如果这个环里面有两台设备下线，那么就会变成两个单独的网络

改进成这样呢？
```
                +-------+
    +---------->| Node2 |<----------+
    |           +-------+           |
    |               ↑               |
    ↓               |               ↓
+-------+           |           +-------+
| Node1 |<----------+---------->| Node3 |
+-------+           |           +-------+
    ↑               |               ↑
    |               ↓               |
    |           +-------+           |
    +---------->| Node4 |<----------+
                +-------+
```
确实解决了上面的那两个问题，新的问题出现了： 一台电脑要连三根网线，总共是3+2+1=6根网线，看起来还好，但想象一下有10台机器，那就是10+9+8+7+6+5+4+3+2+1=55根，根本没法想象应该怎么布线。

很明显这种只靠网线的办法在局域网中就行不通，更别说将世界上所有设备互联了。

于是人们想到引入一种新的设备，用来负责连接各个机器，机器只要和这个新的设备打交道就可以了，于是有了下面这样的连接方式：
```
                +-------+
                | Node2 |
                +-------+
                    ↑
                    |
                    ↓
               +--------+
+-------+      |        |      +-------+
| Node1 |<---->| Device |<---->| Node3 |
+-------+      |        |      +-------+
               +--------+
                    ↑
                    |
                    ↓
                +-------+
                | Node4 |
                +-------+
```

这样看起来就简洁多了，并且往这个网络中添加机器也非常简单，牵一根线到中心的那个设备就可以了。当然这样的组网也有缺点，那就是中心的那个设备挂了后，整个网络就不通了，所以中心设备的功能一定要越简单越好，这样就能保证其稳定性。

其实上面的这两种连接方式就是我们常说的环形网络和星形网络，环形网络不常见，只在某些特殊场合使用，而星形网络就是我们现在常见的组网方式。

有了星形网络网络后，物理连接上没问题了，那么接下来的问题就是怎么通信，Node1要发数据给Node4，肯定要先发给中间的Device，那么Device怎么知道要发给Node4，而不是Node3呢？ Node1和Node3都给Node4发数据，Node4怎么区分数据是谁发给它的呢？这时候链路层就登场了。


##链路层
为了解决上面物理层遇到的问题，聪明的人们设计了一种链路层协议，叫以太网协议。

因为机器之间要通过网线通信，那么每台机器上都有一个处理数据传输的硬件，这个硬件就是网卡，在以太网协议中，要求每个网卡都要有一个地址，就是我们常说的网卡（mac）地址，并且这个地址必须唯一，不能冲突。

为了解决网卡地址唯一这个问题，人们将网卡地址拆成两个部分，第一部分是厂商的ID，另一部分由厂商自己控制，由于厂商的ID是唯一的，所以只要厂商自己不生产同样mac地址的网卡，那么所有厂商的网卡地址都将唯一。

有了mac地址后，Node1给Node4发的数据包中就可以带上各自的mac地址，这样就能唯一的标识这个包是由谁发给谁的了，这样的数据包就是以太网数据包，当然以太网协议还有其它的字段，但这两个字段是最重要的。

现在知道数据包是由谁发给谁的了，另一个问题来了，中心的那个Device收到Node1发给Node4的包之后，怎么知道Node4是连接到哪个端口上的呢？

最开始人们采用的是简单粗暴的方法，那就是群发，由于中心的那个Device不知道Node4连接到哪个端口的，那么它就会将数据复制多份，向所有端口都发一份（Node1所在的端口除外，因为Device知道数据包是从这个端口发进来的），这样Node4就收到了Node1发过来的数据，当然其它两个Node也会收到相应的数据包，但网卡很老实，发现不是发给自己的数据包，就不看包里面的内容，直接把数据包丢弃了。

上面这种简单粗暴的设备就是我们常说的集线器（Hub），从它的工作方式我们可以看出它有两个缺点：

* 数据不安全： Node1发给Node4的数据会被发送到Node2和Node3上去，虽然网卡默认情况下会丢弃该数据包，但是也可以设置网卡为混杂模式，从而可以接收并处理这些数据包。
* 性能差： Node1跟Node4通信的所有数据包都要发给Node2和Node3一份，一方面增加Device的压力，并且还要占用和Node2及Node3之间的带宽

为了解决集线器的问题，人们发明了交换机，跟集线器相比，交换机里面多了一张转发表，里面包含了mac地址和端口的对应关系，大概如下：

| mac地址 | 端口 |
| :--- |  :--- |
|02:42:83:06:75:13 |2 |
|08:00:27:03:d0:e7|2 |
|ee:35:41:bb:a4:60|3|
|02:42:34:8F:0E:FE|4  |

上表表示02:42:83:06:75:13和08:00:27:03:d0:e7连接在交换机的2号端口，ee:35:41:bb:a4:60连接到3号端口，02:42:34:8F:0E:FE连接到4号端口。

这里02:42:83:06:75:13和08:00:27:03:d0:e7都与端口2相连，表示与端口2连接的是一个交换机或者有多个虚拟网卡的机器。

有了这张表之后，交换机收到数据包之后，就知道要从哪个端口发出去了，于是解决了集线器的那两个问题，那么这里又有一个问题，这张表示从哪里来的？？

交换机在刚启动时，这张表是空的，当收到第一个数据包的时候，它也不知道要从哪个端口转发出去，于是它采用和集线器一样的方式广播出去，每次从一个端口收到数据包时，都会根据数据包中的源mac地址添加或者更新转发表，这样很快就会将转发表构造起来，就算有网线换了端口，也会及时的更新转发表。

有了交换机后，局域网是搭建起来了，但是可以通过N个交换机将世界上的所有机器都连起来吗？就像下面这样：
```
                                +---------+
                                |         |        +-------+
                +-------+       | Switch3 |------->| Node5 |
                | Node2 |       |         |        +-------+
                +-------+       +---------+
                    ↑                ↑
                    |                |
                    ↓                ↓
               +---------+      +---------+      +---------+      +----------+
+-------+      |         |      |         |      |         |      |          |        +--------+
| Node1 |<---->| Switch1 |<---->| Switch2 |<---->| ....... |<---->| Switch N |------->| Node N |
+-------+      |         |      |         |      |         |      |          |        +--------+
               +---------+      +---------+      +---------+      +----------+
                    ↑                ↑
                    |                |
                    ↓                ↓
                +-------+        +-------+
                | Node3 |        | Node4 |
                +-------+        +-------+
```

